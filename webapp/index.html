<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crypto Poker Table</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; background:#0f0f0f; color:#fff; font-family:Arial,sans-serif; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px; background:#1f1f1f; }
    .user { display:flex; align-items:center; }
    .avatar { width:40px; height:40px; border-radius:50%; background:#333; margin-right:10px; }
    .info { display:flex; align-items:center; }
    .balance { margin-left:8px; }
    .actions { display:flex; padding:12px; background:#1a1a1a; }
    .actions button { flex:1; margin:0 6px; padding:10px; background:#ffd700; border:none; border-radius:4px; color:#000; cursor:pointer; }
    .tabs { display:flex; padding:8px 12px; background:#1a1a1a; }
    .tab { flex:1; text-align:center; padding:8px; color:#888; cursor:pointer; }
    .tab.active { color:#fff; border-bottom:2px solid #ffd700; }
    #level-select { margin-left:12px; padding:6px; background:#333; border:none; color:#fff; border-radius:4px; }
    main { position:relative; width:100%; height:calc(100vh - 136px); overflow:hidden; }

    /* –ü–æ–∫–µ—Ä–Ω—ã–π —Å—Ç–æ–ª */
    .table-container { position:relative; width:100%; height:100%; background:url('table_bg.png') center/cover no-repeat; }
    .community-cards { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); display:flex; }
    .community-cards img, .hole-cards img { width:60px; height:90px; margin:0 4px; }
    .hole-cards { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); display:flex; }
    .players { position:absolute; width:100%; height:100%; top:0; left:0; }
    .player-seat { position:absolute; width:80px; text-align:center; }
    .player-seat img.avatar { width:60px; height:60px; border-radius:50%; border:2px solid #ffd700; }
    /* –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ */
    .seat-0 { top:10%; left:50%; transform:translateX(-50%); }
    .seat-1 { top:30%; right:10%; }
    .seat-2 { bottom:30%; right:10%; }
    .seat-3 { bottom:10%; left:50%; transform:translateX(-50%); }
    .seat-4 { bottom:30%; left:10%; }
    .seat-5 { top:30%; left:10%; }

    .controls { position:absolute; bottom:20px; right:20px; display:flex; align-items:center; }
    .controls button, .controls input { margin-left:6px; padding:8px; border:none; border-radius:4px; }
    .controls button { background:#ffd700; color:#000; cursor:pointer; }
    .controls input { width:80px; }
  </style>
</head>
<body>
  <header>
    <div class="user">
      <div class="avatar"></div>
      <div class="info">
        <div id="username">‚Äî</div>
        <div class="balance">üí∞ <span id="current-balance">0.00 USDT</span></div>
      </div>
    </div>
    <select id="level-select">
      <option>Low</option><option>Mid</option><option>VIP</option>
    </select>
  </header>
  <div class="actions">
    <button id="deposit">–î–µ–ø–æ–∑–∏—Ç</button>
    <button id="withdraw">–í—ã–≤–µ—Å—Ç–∏</button>
    <button id="history">–ò—Å—Ç–æ—Ä–∏—è</button>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="cash">–ö—ç—à</div>
    <div class="tab" data-tab="tournaments">–¢—É—Ä–Ω–∏—Ä—ã</div>
    <div class="tab" data-tab="more">–ï—â—ë</div>
  </div>
  <div id="info" style="padding:12px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>

  <main>
    <div class="table-container" id="table-container" style="display:none;">
      <div class="community-cards" id="community-cards">
        <!-- –û–±—â–∏–µ –∫–∞—Ä—Ç—ã -->
      </div>
      <div class="hole-cards" id="hole-cards">
        <!-- –ö–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–∞ -->
      </div>
      <div class="players" id="players">
        <!-- –°–ª–∞–π–¥—ã –∏–≥—Ä–æ–∫–æ–≤ -->
      </div>
      <div class="controls" id="controls">
        <button id="btn-check">Check</button>
        <button id="btn-fold">Fold</button>
        <input id="bet-amount" type="number" placeholder="–°—É–º–º–∞">
        <button id="btn-bet">Bet</button>
      </div>
    </div>
  </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const webapp = Telegram.WebApp;
  webapp.ready();
  const params = new URLSearchParams(window.location.search);
  const userId = params.get('user_id');
  document.getElementById('username').textContent = params.get('username') || '‚Äî';
  document.getElementById('current-balance').textContent = '0.00 USDT'; // –æ–±–Ω–æ–≤–∏—Ç—Å—è
  let currentTable;
  let ws;

  async function api(path, query="") {
    const url = `${path}${query}&user_id=${userId}&table_id=${currentTable}`;
    const res = await fetch(url);
    return res.json();
  }

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å—Ç–æ–ª–∞
  function renderTable(state) {
    document.getElementById('info').style.display = 'none';
    const container = document.getElementById('table-container');
    container.style.display = 'block';
    // hole cards
    const hole = document.getElementById('hole-cards'); hole.innerHTML = '';
    state.hole_cards.forEach(c=>{
      const img = document.createElement('img'); img.src = `/cards/${c}.png`;
      hole.append(img);
    });
    // community
    const comm = document.getElementById('community-cards'); comm.innerHTML = '';
    state.community.forEach(c=>{
      const img = document.createElement('img'); img.src = c?`/cards/${c}.png`:'/cards/back.png';
      comm.append(img);
    });
    // players avatars
    const playersDiv = document.getElementById('players'); playersDiv.innerHTML = '';
    let idx=0;
    for(const uid in state.chips) {
      const seat = document.createElement('div');
      seat.className = `player-seat seat-${idx}`;
      seat.innerHTML = `
        <img class="avatar" src="/avatars/${uid}.png" />
        <div>${state.chips[uid]}</div>
      `;
      playersDiv.append(seat);
      idx = (idx+1)%6;
    }
    // pot, current
    document.getElementById('pot').textContent = state.pot;
    document.getElementById('current-player').textContent = state.current_player;

    // WS reconnect
    if(ws) ws.close();
    ws = new WebSocket(`wss://${location.host}/ws/game/${currentTable}`);
    ws.onmessage = e=> renderTable(JSON.parse(e.data));
  }

  // –í—Ö–æ–¥ –∑–∞ —Å—Ç–æ–ª
  async function joinTable(id) {
    currentTable = id;
    const join = await fetch(`/api/join?user_id=${userId}&table_id=${id}`);
    const j = await join.json();
    if(j.success) {
      const state = await fetch(`/api/game_state?user_id=${userId}&table_id=${id}`).then(r=>r.json());
      renderTable(state);
    } else {
      document.getElementById('info').textContent = j.message;
    }
  }

  // –õ–∏—Å—Ç–µ–Ω–µ—Ä—ã –∫—ç—à-—Å—Ç–æ–ª–æ–≤
  document.querySelector('.tab[data-tab="cash"]').onclick = async ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelector('.tab[data-tab="cash"]').classList.add('active');
    document.getElementById('table-container').style.display='none';
    document.getElementById('info').style.display='block';
    const level = document.getElementById('level-select').value;
    const tables = await fetch(`/api/tables?mode=cash&level=${level}&user_id=${userId}`).then(r=>r.json());
    const info = document.getElementById('info'); info.innerHTML='';
    tables.forEach(t=>{
      const div = document.createElement('div');
      div.innerHTML = `<strong>–°—Ç–æ–ª ${t.id}</strong><br>${t.small_blind}/${t.big_blind} ‚Äî –±–∞–π-–∏–Ω ${t.buy_in} ‚Äî ${t.players}<br>`+
                      `<button onclick="joinTable(${t.id})">–ò–≥—Ä–∞—Ç—å</button>`;
      info.append(div);
    });
  };

  // Actions: Deposit/Withdraw/History (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
  document.getElementById('deposit').onclick = () => {/* ... */};
  document.getElementById('withdraw').onclick = () => {/* ... */};
  document.getElementById('history').onclick = () => {/* ... */};

  // Game controls
  document.getElementById('btn-check').onclick = () => ws.send(JSON.stringify({action:'check',user_id:+userId}));
  document.getElementById('btn-fold').onclick  = () => ws.send(JSON.stringify({action:'fold', user_id:+userId}));
  document.getElementById('btn-bet').onclick   = () => {
    const amt = +document.getElementById('bet-amount').value;
    ws.send(JSON.stringify({action:'bet', amount:amt, user_id:+userId}));
  };

  // –ó–∞–ø—É—Å–∫
  document.querySelector('.tab[data-tab="cash"]').click();
});
</script>
</body>
</html>
