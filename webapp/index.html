<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Crypto Poker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#0f0f0f; color:#fff; }
    header { padding:16px; background:#1f1f1f; display:flex; justify-content:space-between; align-items:center; }
    .user { display:flex; align-items:center; }
    .user .avatar { width:40px;height:40px;border-radius:50%;background:#333;margin-right:8px; }
    .user .name { font-weight:bold; margin-right:12px; }
    .balance { display:flex; align-items:center; }
    .balance span { margin-left:4px; }
    .actions { padding:16px; display:flex; gap:12px; background:#1a1a1a; }
    .actions button { flex:1; padding:12px; border:none;border-radius:4px;background:#ffd700;color:#000;font-weight:bold;cursor:pointer; }
    .tabs { display:flex; background:#1a1a1a; }
    .tabs .tab { flex:1; text-align:center; padding:12px; cursor:pointer; color:#888; }
    .tabs .tab.active { color:#fff; border-bottom:3px solid #ffd700; }
    #info { padding:16px; min-height:200px; white-space:pre-wrap; }
    .table { margin-bottom:16px; }
    .table button { margin-top:4px; padding:6px 12px; }
  </style>
</head>
<body>
  <header>
    <div class="user">
      <div class="avatar" id="avatar"></div>
      <div class="name" id="username">‚Äî</div>
      <div class="balance">üí∞<span id="current-balance">0.00 USDT</span></div>
    </div>
    <select id="level-select">
      <option value="Low">Low</option>
      <option value="Mid">Mid</option>
      <option value="VIP">VIP</option>
    </select>
  </header>

  <div class="actions">
    <button id="deposit">–î–µ–ø–æ–∑–∏—Ç</button>
    <button id="withdraw">–í—ã–≤–µ—Å—Ç–∏</button>
    <button id="history">–ò—Å—Ç–æ—Ä–∏—è</button>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="cash">–ö—ç—à</div>
    <div class="tab" data-tab="tournaments">–¢—É—Ä–Ω–∏—Ä—ã</div>
    <div class="tab" data-tab="more">–ï—â—ë</div>
  </div>

  <div id="info">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É</div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // –ü–∞—Ä—Å–∏–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    const params   = new URLSearchParams(location.search);
    const userId   = params.get('user_id');
    const username = decodeURIComponent(params.get('username')||'‚Äî');

    // –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π URL –≤–∞—à–µ–≥–æ API
    const API_BASE = 'https://crypto-poker-webapp.onrender.com';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–ø–∫—É
    document.getElementById('username').textContent = username;
    const balanceEl = document.getElementById('current-balance');
    const info      = document.getElementById('info');
    const levelSel  = document.getElementById('level-select');

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ fetch ‚Üí JSON
    async function api(path, extra={}) {
      const url = new URL(API_BASE + path);
      url.search = new URLSearchParams({ user_id: userId, ...extra }).toString();
      console.log('‚Üí', url.toString());
      const res = await fetch(url.toString());
      console.log('‚Üê', res.status, await res.clone().json().catch(()=>res.statusText));
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
    api('/api/balance').then(({balance}) => {
      balanceEl.textContent = balance.toFixed(2) + ' USDT';
    }).catch(()=>{});

    // –î–µ–ø–æ–∑–∏—Ç / –í—ã–≤–µ—Å—Ç–∏ / –ò—Å—Ç–æ—Ä–∏—è
    document.getElementById('deposit').onclick = async () => {
      try {
        const { address } = await api('/api/deposit');
        info.textContent = `üì• –ß—Ç–æ–±—ã –ø–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á—ë—Ç, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–æ–Ω–µ—Ç—ã –Ω–∞ –∞–¥—Ä–µ—Å:\n${address}`;
      } catch {
        info.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–µ';
      }
    };
    document.getElementById('withdraw').onclick = async () => {
      try {
        const { instructions } = await api('/api/withdraw');
        info.textContent = `üì§ ${instructions}`;
      } catch {
        info.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ';
      }
    };
    document.getElementById('history').onclick = async () => {
      try {
        const { history } = await api('/api/history');
        info.textContent = history.length
          ? history.join('\n')
          : 'üìú –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞';
      } catch {
        info.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏';
      }
    };

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        if (tab.dataset.tab === 'cash') loadCash();
        else if (tab.dataset.tab === 'tournaments') loadTournaments();
        else info.textContent = '–°–∫–æ—Ä–æ‚Ä¶';
      };
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–µ—à-—Å—Ç–æ–ª–æ–≤
    async function loadCash() {
      info.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–æ–ª–æ–≤‚Ä¶';
      try {
        const tables = await api('/api/tables', { level: levelSel.value });
        info.innerHTML = '';
        tables.forEach(t => {
          const d = document.createElement('div');
          d.className = 'table';
          d.innerHTML = `
            <strong>–°—Ç–æ–ª ${t.id}</strong><br>
            SB/BB: ${t.small_blind}/${t.big_blind}<br>
            –ë–∞–π-–∏–Ω: ${t.buy_in}  |  –ò–≥—Ä–æ–∫–∏: ${t.players}<br>
            <button data-id="${t.id}">–ò–≥—Ä–∞—Ç—å</button>
          `;
          info.appendChild(d);

          // –ù–∞–∂–∞—Ç–∏–µ ¬´–ò–≥—Ä–∞—Ç—å¬ª
          d.querySelector('button').onclick = async () => {
            try {
              // —Å–Ω–∞—á–∞–ª–∞ join
              const j = await api('/api/join', { table_id: t.id });
              if (!j.success) {
                info.textContent = j.message;
                return;
              }
              // –∑–∞—Ç–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ game.html
              const url = `${API_BASE}/game.html?user_id=${userId}&table_id=${t.id}`;
              if (window.Telegram && Telegram.WebApp) Telegram.WebApp.openLink(url);
              else window.location.href = url;
            } catch (err) {
              console.error(err);
              info.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å—Ç–æ–ª—É';
            }
          };
        });
      } catch (err) {
        console.error(err);
        info.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–æ–ª–æ–≤';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—É—Ä–Ω–∏—Ä–æ–≤
    async function loadTournaments() {
      info.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—É—Ä–Ω–∏—Ä–æ–≤‚Ä¶';
      try {
        const list = await api('/api/tournaments');
        info.innerHTML = '';
        list.forEach(tr => {
          const d = document.createElement('div');
          d.className = 'table';
          d.innerHTML = `
            <strong>${tr.name}</strong><br>
            –ë–∞–π-–∏–Ω: ${tr.buy_in}  |  –ò–≥—Ä–æ–∫–∏: ${tr.players}/${tr.max_players}<br>
            –°—Ç–∞—Ç—É—Å: ${tr.status}<br>
            <button data-id="${tr.id}">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
          `;
          info.appendChild(d);
          d.querySelector('button').onclick = async () => {
            try {
              await api('/api/join_tournament', { tournament_id: tr.id });
              info.textContent = '–í—ã –≤ —Ç—É—Ä–Ω–∏—Ä–µ! üéâ';
            } catch (e) {
              info.textContent = e.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
            }
          };
        });
      } catch (err) {
        console.error(err);
        info.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç—É—Ä–Ω–∏—Ä–æ–≤';
      }
    }

    // –ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç
    loadCash();
  });
  </script>
</body>
</html>
