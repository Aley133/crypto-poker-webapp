<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crypto Poker</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {margin:0; font-family:Arial,sans-serif; background:#0f0f0f; color:#fff;}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px;background:#1f1f1f}
    .user{display:flex;align-items:center}
    .avatar{width:40px;height:40px;background:#333;border-radius:50%;margin-right:12px}
    .info{display:flex;align-items:center}
    .balance{margin-left:8px}
    .actions, .tabs{display:flex;padding:16px;background:#1a1a1a}
    .actions button, .tabs .tab{flex:1;margin:0 8px;padding:10px;border:none;border-radius:4px;cursor:pointer}
    .actions button{background:#ffd700;color:#000}
    .tabs .tab{background:transparent;color:#888}
    .tabs .tab.active{color:#fff;border-bottom:2px solid #ffd700}
    #level-select{margin-left:16px;padding:6px;border:none;border-radius:4px;background:#333;color:#fff}
    #info{padding:16px;white-space:pre-wrap}
    #game-area{padding:16px}
    .card{display:inline-block;width:40px;height:60px;background:#fff;color:#000;border-radius:4px;margin:0 4px;text-align:center;line-height:60px;font-weight:bold}
  </style>
</head>
<body>
  <header>
    <div class="user">
      <div class="avatar"></div>
      <div class="info">
        <div id="username">‚Äî</div>
        <div class="balance">üí∞ <span id="current-balance">0.00 USDT</span></div>
      </div>
    </div>
    <select id="level-select">
      <option>Low</option><option>Mid</option><option>VIP</option>
    </select>
  </header>
  <div class="actions">
    <button id="deposit">–î–µ–ø–æ–∑–∏—Ç</button>
    <button id="withdraw">–í—ã–≤–µ—Å—Ç–∏</button>
    <button id="history">–ò—Å—Ç–æ—Ä–∏—è</button>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="cash">–ö—ç—à</div>
    <div class="tab" data-tab="tournaments">–¢—É—Ä–Ω–∏—Ä—ã</div>
    <div class="tab" data-tab="more">–ï—â—ë</div>
  </div>
  <div id="info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>

  <!-- –ò–≥—Ä–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
  <div id="game-area" style="display:none;">
    <h2>–°—Ç–æ–ª <span id="table-id"></span></h2>
    <div>–í–∞—à–∏ –∫–∞—Ä—Ç—ã: <span id="hole-cards"></span></div>
    <div>–°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∫–∞—Ä—Ç—ã: <span id="community-cards"></span></div>
    <div>–ë–∞–Ω–∫: <span id="pot"></span></div>
    <div>–í–∞—à —Å—Ç–µ–∫: <span id="my-chips"></span></div>
    <div>–•–æ–¥–∏—Ç: <span id="current-player"></span></div>
    <div>
      <button id="btn-check">Check</button>
      <button id="btn-fold">Fold</button>
      <input id="bet-amount" type="number" placeholder="–°—É–º–º–∞" style="width:80px"> <button id="btn-bet">Bet</button>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const webapp = Telegram.WebApp;
    webapp.ready();

    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    const username = params.get('username') || '‚Äî';
    let mode = 'cash', level = document.getElementById('level-select').value;

    document.getElementById('username').textContent = username;

    async function api(path, method='GET', body=null) {
      let url = `${path}?user_id=${userId}&mode=${mode}&level=${level}`;
      if(path.includes('join')||path.includes('game_state')) url = `${path}?user_id=${userId}&table_id=${currentTable}`;
      const opts = {method, headers:{'Content-Type':'application/json'}};
      if(body) opts.body = JSON.stringify(body);
      const res = await fetch(url, opts);
      return res.json();
    }

    // Cash UI
    let currentTable;
    document.querySelectorAll('.tab').forEach(tab=>tab.onclick = async ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('game-area').style.display='none';
      mode = tab.dataset.tab;
      const info = document.getElementById('info');
      if(mode==='cash'){
        level = document.getElementById('level-select').value;
        try{
          const tables = await api('/api/tables');
          info.innerHTML='';
          tables.forEach(t=>{
            const div=document.createElement('div');
            div.innerHTML = `<strong>–°—Ç–æ–ª ${t.id}</strong><br>${t.small_blind}/${t.big_blind} ‚Äî –±–∞–π-–∏–Ω ${t.buy_in} ‚Äî ${t.players}<br><button data-id="${t.id}">–ò–≥—Ä–∞—Ç—å</button>`;
            info.append(div);
          });
          info.querySelectorAll('button').forEach(btn=>btn.onclick=async ()=>{
            currentTable=btn.dataset.id;
            const join=await api('/api/join');
            if(join.success){ loadGame(); } else { info.textContent=join.message; }
          });
        }catch{info.textContent='–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–æ–ª–æ–≤'}
      }
      // TODO: tournaments/more
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Cash –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    document.querySelector('.tab[data-tab="cash"]').click();

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã
    async function loadGame(){
      const state = await api('/api/game_state');
      document.getElementById('info').innerHTML='';
      document.getElementById('game-area').style.display='block';
      document.getElementById('table-id').textContent=state.table_id;
      document.getElementById('hole-cards').innerHTML = state.hole_cards.map(c=>`<span class="card">${c}</span>`).join('');
      document.getElementById('community-cards').innerHTML = state.community.map(c=>c?`<span class="card">${c}</span>`:'').join('');
      document.getElementById('pot').textContent = state.pot;
      document.getElementById('my-chips').textContent = state.chips[userId];
      document.getElementById('current-player').textContent = state.current_player;

      // WebSocket
      const ws = new WebSocket(`wss://${location.host}/ws/game/${currentTable}`);
      ws.onmessage = e=>{
        const st = JSON.parse(e.data);
        // –æ–±–Ω–æ–≤–ª—è–µ–º UI –∫–∞–∫ –≤—ã—à–µ
        document.getElementById('pot').textContent = st.pot;
        document.getElementById('community-cards').innerHTML = st.community.map(c=>c?`<span class="card">${c}</span>`:'').join('');
        document.getElementById('my-chips').textContent = st.chips[userId];
        document.getElementById('current-player').textContent = st.current_player;
      };

      document.getElementById('btn-check').onclick = ()=>ws.send(JSON.stringify({action:'check',user_id:parseInt(userId)}));
      document.getElementById('btn-fold').onclick = ()=>ws.send(JSON.stringify({action:'fold',user_id:parseInt(userId)}));
      document.getElementById('btn-bet').onclick = ()=>{
        const amt = parseFloat(document.getElementById('bet-amount').value);
        ws.send(JSON.stringify({action:'bet',amount:amt,user_id:parseInt(userId)}));
      };
    }

  });
  </script>
</body>
</html>
