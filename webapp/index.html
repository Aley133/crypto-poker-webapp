<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Poker WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial,sans-serif; background:#0f0f0f; color:#fff; margin:0; }
    header { padding:16px; display:flex; justify-content:space-between; background:#1f1f1f; }
    .user { display:flex; align-items:center; }
    .user .avatar { width:40px; height:40px; background:#333; border-radius:50%; margin-right:12px; }
    .user .name { font-weight:bold; }
    .balance { display:flex; align-items:center; }
    .actions, .tabs { display:flex; padding:16px; background:#1a1a1a; }
    .actions button, .tabs .tab { flex:1; margin:0 8px; padding:10px; border:none; border-radius:4px; cursor:pointer; }
    .actions button { background:#ffd700; color:#000; }
    .tabs .tab { background:transparent; color:#888; }
    .tabs .tab.active { color:#fff; border-bottom:2px solid #ffd700; }
    #info { padding:16px; }
  </style>
</head>
<body>
  <header>
    <div class="user">
      <div class="avatar"></div>
      <div>
        <div class="name" id="username">‚Äî</div>
        <div class="balance">üí∞ <span id="current-balance">0.00 USDT</span></div>
      </div>
    </div>
  </header>
  <div class="actions">
    <button id="deposit">–î–µ–ø–æ–∑–∏—Ç</button>
    <button id="withdraw">–í—ã–≤–µ—Å—Ç–∏</button>
    <button id="history">–ò—Å—Ç–æ—Ä–∏—è</button>
  </div>
  <div class="tabs">
    <div class="tab active" data-tab="cash">–ö—ç—à</div>
    <div class="tab" data-tab="tournaments">–¢—É—Ä–Ω–∏—Ä—ã</div>
    <div class="tab" data-tab="more">–ï—â—ë</div>
  </div>
  <div id="info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const userId   = params.get('user_id');
    const username = params.get('username');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    document.getElementById('username').textContent = username || '‚Äî';

    // –•–µ–ª–ø–µ—Ä –≤—ã–∑–æ–≤–∞ API
    async function callApi(path) {
      const res = await fetch(`${path}?user_id=${userId}`);
      if (!res.ok) throw new Error(res.status);
      return res.json();
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
    callApi('/api/balance')
      .then(({balance}) => {
        document.getElementById('current-balance').textContent = `${balance.toFixed(2)} USDT`;
      })
      .catch(console.error);

    // –î–µ–ø–æ–∑–∏—Ç
    document.getElementById('deposit').onclick = async () => {
      try {
        const {address} = await callApi('/api/deposit');
        document.getElementById('info').textContent = `üì• –ê–¥—Ä–µ—Å: ${address}`;
      } catch {
        document.getElementById('info').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–µ';
      }
    };
    // –í—ã–≤–æ–¥
    document.getElementById('withdraw').onclick = async () => {
      try {
        const {instructions} = await callApi('/api/withdraw');
        document.getElementById('info').textContent = `üì§ ${instructions}`;
      } catch {
        document.getElementById('info').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–≤–æ–¥–µ';
      }
    };
    // –ò—Å—Ç–æ—Ä–∏—è
    document.getElementById('history').onclick = async () => {
      try {
        const {history} = await callApi('/api/history');
        document.getElementById('info').textContent = history.length
          ? history.join('\\n')
          : 'üìú –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞';
      } catch {
        document.getElementById('info').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏';
      }
    };
  });
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');
    let currentMode  = 'cash';
    let currentLevel = 'Low';

    async function fetchTables() {
      const res = await fetch(
        `/api/tables?user_id=${userId}&mode=${currentMode}&level=${currentLevel}`
      );
      const tables = await res.json();
      renderTables(tables);
    }

    function renderTables(tables) {
      const info = document.getElementById('info');
      info.innerHTML = ''; 
      tables.forEach(t => {
        const div = document.createElement('div');
        div.style.margin = '8px 0';
        div.innerHTML = `
          <strong>–°—Ç–æ–ª ${t.id}</strong><br/>
          ${t.small_blind}/${t.big_blind} ‚Äï –±–∞–π-–∏–Ω ${t.buy_in} ‚Äï ${t.players}
          <button data-id="${t.id}">–ò–≥—Ä–∞—Ç—å</button>
        `;
        info.append(div);
      });
      // –ù–∞–≤–µ—à–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏
      info.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async () => {
          const tid = btn.dataset.id;
          const resp = await fetch(`/api/join?user_id=${userId}&table_id=${tid}`);
          const json = await resp.json();
          info.textContent = json.message;
        });
      });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–∞–±–æ–≤
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // –°–Ω–∏–º–∞–µ–º active, —Å—Ç–∞–≤–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        if (tab.dataset.tab === 'cash') {
          currentMode = 'cash';
          // —É—Ä–æ–≤–µ–Ω—å –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–ª–µ–∫—Ç–æ–º, –∞ –ø–æ–∫–∞ –ø–æ –¥–µ—Ñ–æ–ª—Ç—É Low
          currentLevel = 'Low';
          fetchTables();
        }
        // TODO: —Ç—É—Ä–Ω–∏—Ä—ã –∏ ¬´–ï—â—ë¬ª
      });
    });

    // –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à-—Å—Ç–æ–ª—ã
    fetchTables();
  });
</script>
</body>
</html>
